apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nginx-gateway-fabric
  namespace: nginx-gateway
spec:
  interval: 30m
  dependsOn:
    - name: aws-load-balancer-controller
      namespace: kube-system
  chart:
    spec:
      chart: nginx-gateway-fabric
      version: "1.6.*"
      sourceRef:
        kind: HelmRepository
        name: nginx-gateway
        namespace: flux-system
      interval: 12h
  values:
    # NGINX Gateway Fabric configuration
    nginxGateway:
      # Enable leader election for HA
      leaderElection:
        enabled: true

      # Gateway API configuration
      gatewayClassName: nginx

      # Logging
      logging:
        level: info

    # NGINX configuration
    nginx:
      # Use NGINX Plus if licensed, otherwise OSS
      image:
        repository: ghcr.io/nginx/nginx-gateway-fabric/nginx
        tag: "1.6.2"

      # Resource limits
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 1
          memory: 1Gi

    # Service configuration for AWS NLB
    service:
      type: LoadBalancer
      annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: "external"
        service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
        service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
        service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
        service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
      externalTrafficPolicy: Local
